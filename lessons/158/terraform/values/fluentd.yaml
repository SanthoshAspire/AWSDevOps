---
forwarder:
  tolerations:
    - key: fluentd
      operator: Exists
      effect: NoSchedule

  nodeSelector:
    service: myapp

  configMapFiles:
    fluentd-inputs.conf: |
      # HTTP input for the liveness and readiness probes
      <source>
        @type http
        port 9880
      </source>
      # Get the logs from the containers running in the node
      <source>
        @type tail
        path /var/log/containers/*.log
        # exclude Fluentd logs
        exclude_path /var/log/containers/*fluentd*.log
        pos_file /opt/bitnami/fluentd/logs/buffers/fluentd-docker.pos
        tag kubernetes.*
        read_from_head true
      <parse>
        @type regexp
        expression /^(?<time>.+) (?<stream>stdout|stderr)( (?<logtag>.))? (?<log>.*)$/
      </parse>
      </source>
      # enrich with kubernetes metadata
      <filter kubernetes.**>
        @type kubernetes_metadata
      </filter>

    fluentd-output.conf: |
      # Throw the healthcheck to the standard output instead of forwarding it
      <match fluentd.healthcheck>
        @type stdout
      </match>

      <match **>
        @type s3

        aws_key_id 3QcqU1kVw2GkpAbQ
        aws_sec_key rR5yI4ntfmf9x1YRNgNCg97fmUGihdBf
        s3_bucket fluentd
        s3_endpoint "http://minio.s3:9000/"
        force_path_style true
        s3_region us-west-1
        path logs/

        <buffer tag,time>
          @type file
          path /var/log/fluent/s3
          timekey 3600 # 1 hour partition
          timekey_wait 10m
          timekey_use_utc true # use utc
          chunk_limit_size 256m
        </buffer>

      </match>

    fluentd.conf: |
      # Ignore fluentd own events
      <match fluent.**>
        @type null
      </match>

      @include fluentd-inputs.conf
      @include fluentd-output.conf
aggregator:
  enabled: false
